/*
    run the file to create the first roid_address smart contract
    npx ts-node -P tsconfig.server.json ./blockchain/ethereum_env.ts
*/ 

import Web3 from 'web3';
import { send_sign_tx } from '../vautlBX/methods';
import { promises as fs } from 'fs';
import path from 'path';

export { web3, roid_address_smart_contract_instance, deploy_ro_smartcontract, get_ro_contract_address, get_ro_smart_contract_instance, deploy_roid_address, get_public_wallet, get_roid_address };


// creating Web3 instance to localhost Hardhat
const web3 = new Web3('http://localhost:8545');

//ganache first wallet address
const get_public_wallet = async () => {
    const accounts = await web3.eth.getAccounts();
    return accounts[0];
}

// ================================ smart contract - roid_address =============================================
const roid_address_abi = [
    {
        "inputs": [],
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "owner",
                "type": "address"
            }
        ],
        "name": "OwnableInvalidOwner",
        "type": "error"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "account",
                "type": "address"
            }
        ],
        "name": "OwnableUnauthorizedAccount",
        "type": "error"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "previousOwner",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "newOwner",
                "type": "address"
            }
        ],
        "name": "OwnershipTransferred",
        "type": "event"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "dataid_hash",
                "type": "string"
            }
        ],
        "name": "getRoid",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "roid_hashing",
                "type": "string"
            }
        ],
        "name": "getSmartContract",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "roid_hashing",
                "type": "string"
            }
        ],
        "name": "getVaultBX",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "owner",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "renounceOwnership",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "dataid_hash",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "roid_hash",
                "type": "string"
            }
        ],
        "name": "setDataidRoid",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "roid_hash",
                "type": "string"
            },
            {
                "internalType": "address",
                "name": "smartContract_address",
                "type": "address"
            }
        ],
        "name": "setSmartContract",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "roid_hashing",
                "type": "string"
            },
            {
                "internalType": "address",
                "name": "vaultBX_address",
                "type": "address"
            }
        ],
        "name": "setVaultBX",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "newOwner",
                "type": "address"
            }
        ],
        "name": "transferOwnership",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "roid_hashing",
                "type": "string"
            },
            {
                "internalType": "address",
                "name": "vaultBX_address",
                "type": "address"
            }
        ],
        "name": "verifyVaultBX",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    }
];

const roid_address_bytecode ="608060405234801561000f575f80fd5b50335f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603610081575f6040517f1e4fbdf70000000000000000000000000000000000000000000000000000000081526004016100789190610196565b60405180910390fd5b6100908161009660201b60201c565b506101af565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050815f806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61018082610157565b9050919050565b61019081610176565b82525050565b5f6020820190506101a95f830184610187565b92915050565b610e0a806101bc5f395ff3fe608060405234801561000f575f80fd5b506004361061009c575f3560e01c80638da5cb5b116100645780638da5cb5b14610142578063971cab6f14610160578063c589922014610190578063c6c4fbc6146101c0578063f2fde38b146101dc5761009c565b80633084f152146100a057806340763c3e146100bc5780634986b388146100ec578063648451a81461011c578063715018a614610138575b5f80fd5b6100ba60048036038101906100b59190610821565b6101f8565b005b6100d660048036038101906100d19190610897565b610230565b6040516100e3919061091d565b60405180910390f35b61010660048036038101906101019190610960565b61027e565b60405161011391906109d4565b60405180910390f35b61013660048036038101906101319190610960565b6102f3565b005b61014061035b565b005b61014a61036e565b604051610157919061091d565b60405180910390f35b61017a60048036038101906101759190610897565b610395565b6040516101879190610a67565b60405180910390f35b6101aa60048036038101906101a59190610897565b61044b565b6040516101b7919061091d565b60405180910390f35b6101da60048036038101906101d59190610960565b610499565b005b6101f660048036038101906101f19190610a87565b610501565b005b610200610585565b806003836040516102119190610aec565b9081526020016040518091039020908161022b9190610d05565b505050565b5f610239610585565b6002826040516102499190610aec565b90815260200160405180910390205f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b5f8173ffffffffffffffffffffffffffffffffffffffff166001846040516102a69190610aec565b90815260200160405180910390205f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614905092915050565b6102fb610585565b8060018360405161030c9190610aec565b90815260200160405180910390205f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050565b610363610585565b61036c5f61060c565b565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b606061039f610585565b6003826040516103af9190610aec565b908152602001604051809103902080546103c890610b2f565b80601f01602080910402602001604051908101604052809291908181526020018280546103f490610b2f565b801561043f5780601f106104165761010080835404028352916020019161043f565b820191905f5260205f20905b81548152906001019060200180831161042257829003601f168201915b50505050509050919050565b5f610454610585565b6001826040516104649190610aec565b90815260200160405180910390205f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b6104a1610585565b806002836040516104b29190610aec565b90815260200160405180910390205f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050565b610509610585565b5f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603610579575f6040517f1e4fbdf7000000000000000000000000000000000000000000000000000000008152600401610570919061091d565b60405180910390fd5b6105828161060c565b50565b61058d6106cd565b73ffffffffffffffffffffffffffffffffffffffff166105ab61036e565b73ffffffffffffffffffffffffffffffffffffffff161461060a576105ce6106cd565b6040517f118cdaa7000000000000000000000000000000000000000000000000000000008152600401610601919061091d565b60405180910390fd5b565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050815f806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b5f33905090565b5f604051905090565b5f80fd5b5f80fd5b5f80fd5b5f80fd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b610733826106ed565b810181811067ffffffffffffffff82111715610752576107516106fd565b5b80604052505050565b5f6107646106d4565b9050610770828261072a565b919050565b5f67ffffffffffffffff82111561078f5761078e6106fd565b5b610798826106ed565b9050602081019050919050565b828183375f83830152505050565b5f6107c56107c084610775565b61075b565b9050828152602081018484840111156107e1576107e06106e9565b5b6107ec8482856107a5565b509392505050565b5f82601f830112610808576108076106e5565b5b81356108188482602086016107b3565b91505092915050565b5f8060408385031215610837576108366106dd565b5b5f83013567ffffffffffffffff811115610854576108536106e1565b5b610860858286016107f4565b925050602083013567ffffffffffffffff811115610881576108806106e1565b5b61088d858286016107f4565b9150509250929050565b5f602082840312156108ac576108ab6106dd565b5b5f82013567ffffffffffffffff8111156108c9576108c86106e1565b5b6108d5848285016107f4565b91505092915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f610907826108de565b9050919050565b610917816108fd565b82525050565b5f6020820190506109305f83018461090e565b92915050565b61093f816108fd565b8114610949575f80fd5b50565b5f8135905061095a81610936565b92915050565b5f8060408385031215610976576109756106dd565b5b5f83013567ffffffffffffffff811115610993576109926106e1565b5b61099f858286016107f4565b92505060206109b08582860161094c565b9150509250929050565b5f8115159050919050565b6109ce816109ba565b82525050565b5f6020820190506109e75f8301846109c5565b92915050565b5f81519050919050565b5f82825260208201905092915050565b5f5b83811015610a24578082015181840152602081019050610a09565b5f8484015250505050565b5f610a39826109ed565b610a4381856109f7565b9350610a53818560208601610a07565b610a5c816106ed565b840191505092915050565b5f6020820190508181035f830152610a7f8184610a2f565b905092915050565b5f60208284031215610a9c57610a9b6106dd565b5b5f610aa98482850161094c565b91505092915050565b5f81905092915050565b5f610ac6826109ed565b610ad08185610ab2565b9350610ae0818560208601610a07565b80840191505092915050565b5f610af78284610abc565b915081905092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f6002820490506001821680610b4657607f821691505b602082108103610b5957610b58610b02565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f60088302610bbb7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610b80565b610bc58683610b80565b95508019841693508086168417925050509392505050565b5f819050919050565b5f819050919050565b5f610c09610c04610bff84610bdd565b610be6565b610bdd565b9050919050565b5f819050919050565b610c2283610bef565b610c36610c2e82610c10565b848454610b8c565b825550505050565b5f90565b610c4a610c3e565b610c55818484610c19565b505050565b5b81811015610c7857610c6d5f82610c42565b600181019050610c5b565b5050565b601f821115610cbd57610c8e81610b5f565b610c9784610b71565b81016020851015610ca6578190505b610cba610cb285610b71565b830182610c5a565b50505b505050565b5f82821c905092915050565b5f610cdd5f1984600802610cc2565b1980831691505092915050565b5f610cf58383610cce565b9150826002028217905092915050565b610d0e826109ed565b67ffffffffffffffff811115610d2757610d266106fd565b5b610d318254610b2f565b610d3c828285610c7c565b5f60209050601f831160018114610d6d575f8415610d5b578287015190505b610d658582610cea565b865550610dcc565b601f198416610d7b86610b5f565b5f5b82811015610da257848901518255600182019150602085019450602081019050610d7d565b86831015610dbf5784890151610dbb601f891682610cce565b8355505b6001600288020188555050505b50505050505056fea26469706673582212209bd2f8ae5019e42d54897cd329a3ca8646828334ee8536b2b3fe99544dd43da664736f6c63430008140033";

let roid_address_smart_contract_instance : any;

const deploy_roid_address = async (platform_name : string) => {

    try{
        const public_wallet = await get_public_wallet();

        const contract = new web3.eth.Contract(roid_address_abi as any);
        const contract_instance = await contract.deploy({
            data: roid_address_bytecode,
            arguments: []
        })
        .send({
            from: public_wallet,
            gas: 5000000,      // 增加 gas 限制
            gasPrice: '900000000'    
        });

        roid_address_smart_contract_instance = new web3.eth.Contract(roid_address_abi as any, contract_instance.options.address);

        // storing address for API - verify_rp
        const storageFilePath = path.join(process.cwd(), 'roid_address.txt');
        await fs.writeFile(storageFilePath, contract_instance.options.address);

        console.log(`[deploy smart contract] roid_address deploy for '${platform_name}' at : ${contract_instance.options.address} [OK]`);

        return contract_instance.options.address;
    }catch(err){
        console.log(`[deploy smart contract] roid_address error : ${err}`);
    }
}

const get_roid_address = async (address : string) => {
    roid_address_smart_contract_instance = new web3.eth.Contract(roid_address_abi as any, address);
    return roid_address_smart_contract_instance;
}

// ================================ smart contract - ro_smartcontract  =================================================
const ro_smartcontract_abi = [
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "_RO_id_hashing",
                "type": "string"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "inputs": [],
        "name": "InvalidInitialization",
        "type": "error"
    },
    {
        "inputs": [],
        "name": "NotInitializing",
        "type": "error"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "owner",
                "type": "address"
            }
        ],
        "name": "OwnableInvalidOwner",
        "type": "error"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "account",
                "type": "address"
            }
        ],
        "name": "OwnableUnauthorizedAccount",
        "type": "error"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "string",
                "name": "message",
                "type": "string"
            }
        ],
        "name": "Debug",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "uint64",
                "name": "version",
                "type": "uint64"
            }
        ],
        "name": "Initialized",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "previousOwner",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "newOwner",
                "type": "address"
            }
        ],
        "name": "OwnershipTransferred",
        "type": "event"
    },
    {
        "inputs": [],
        "name": "RO_id_hashing",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            },
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "dataid_authgoals",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            },
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "dataid_authroles",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "name": "dataid_timestamp",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "_RO_id_hashing",
                "type": "string"
            }
        ],
        "name": "initialize",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "owner",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "renounceOwnership",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "data_id",
                "type": "string"
            },
            {
                "internalType": "string[]",
                "name": "authroles",
                "type": "string[]"
            },
            {
                "internalType": "string[]",
                "name": "authgoals",
                "type": "string[]"
            }
        ],
        "name": "set_data_auth",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "newOwner",
                "type": "address"
            }
        ],
        "name": "transferOwnership",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "data_id",
                "type": "string"
            },
            {
                "internalType": "string[]",
                "name": "rp_auth_roles",
                "type": "string[]"
            },
            {
                "internalType": "string[]",
                "name": "rp_auth_goals",
                "type": "string[]"
            }
        ],
        "name": "verify_rp",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            },
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    }
];

const ro_smartcontract_bytecode = "608060405234801562000010575f80fd5b506040516200249c3803806200249c833981810160405281019062000036919062000653565b335f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603620000aa575f6040517f1e4fbdf7000000000000000000000000000000000000000000000000000000008152600401620000a19190620006e5565b60405180910390fd5b620000bb81620000d460201b60201c565b50620000cd816200019560201b60201c565b5062000a8a565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050815f806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b5f620001a66200034060201b60201c565b90505f815f0160089054906101000a900460ff161590505f825f015f9054906101000a900467ffffffffffffffff1690505f808267ffffffffffffffff16148015620001ef5750825b90505f60018367ffffffffffffffff161480156200022357505f3073ffffffffffffffffffffffffffffffffffffffff163b145b90508115801562000232575080155b156200026a576040517ff92ee8a900000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6001855f015f6101000a81548167ffffffffffffffff021916908367ffffffffffffffff1602179055508315620002b8576001855f0160086101000a81548160ff0219169083151502179055505b8560019081620002c9919062000937565b50620002db336200036760201b60201c565b831562000338575f855f0160086101000a81548160ff0219169083151502179055507fc7f505b2f371ae2175ee4913f4499e1f2633a7b5936321eed1cdaeb6115181d260016040516200032f919062000a6f565b60405180910390a15b505050505050565b5f7ff0c57e16840df040f15088dc2f81fe391c3923bec73e23a9662efc9c229c6a00905090565b62000377620003fe60201b60201c565b5f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603620003ea575f6040517f1e4fbdf7000000000000000000000000000000000000000000000000000000008152600401620003e19190620006e5565b60405180910390fd5b620003fb81620000d460201b60201c565b50565b6200040e620004a060201b60201c565b73ffffffffffffffffffffffffffffffffffffffff1662000434620004a760201b60201c565b73ffffffffffffffffffffffffffffffffffffffff16146200049e5762000460620004a060201b60201c565b6040517f118cdaa7000000000000000000000000000000000000000000000000000000008152600401620004959190620006e5565b60405180910390fd5b565b5f33905090565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b5f604051905090565b5f80fd5b5f80fd5b5f80fd5b5f80fd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b6200052f82620004e7565b810181811067ffffffffffffffff82111715620005515762000550620004f7565b5b80604052505050565b5f62000565620004ce565b905062000573828262000524565b919050565b5f67ffffffffffffffff821115620005955762000594620004f7565b5b620005a082620004e7565b9050602081019050919050565b5f5b83811015620005cc578082015181840152602081019050620005af565b5f8484015250505050565b5f620005ed620005e78462000578565b6200055a565b9050828152602081018484840111156200060c576200060b620004e3565b5b62000619848285620005ad565b509392505050565b5f82601f830112620006385762000637620004df565b5b81516200064a848260208601620005d7565b91505092915050565b5f602082840312156200066b576200066a620004d7565b5b5f82015167ffffffffffffffff8111156200068b576200068a620004db565b5b620006998482850162000621565b91505092915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f620006cd82620006a2565b9050919050565b620006df81620006c1565b82525050565b5f602082019050620006fa5f830184620006d4565b92915050565b5f81519050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f60028204905060018216806200074f57607f821691505b6020821081036200076557620007646200070a565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f60088302620007c97fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826200078c565b620007d586836200078c565b95508019841693508086168417925050509392505050565b5f819050919050565b5f819050919050565b5f6200081f620008196200081384620007ed565b620007f6565b620007ed565b9050919050565b5f819050919050565b6200083a83620007ff565b62000852620008498262000826565b84845462000798565b825550505050565b5f90565b620008686200085a565b620008758184846200082f565b505050565b5b818110156200089c57620008905f826200085e565b6001810190506200087b565b5050565b601f821115620008eb57620008b5816200076b565b620008c0846200077d565b81016020851015620008d0578190505b620008e8620008df856200077d565b8301826200087a565b50505b505050565b5f82821c905092915050565b5f6200090d5f1984600802620008f0565b1980831691505092915050565b5f620009278383620008fc565b9150826002028217905092915050565b620009428262000700565b67ffffffffffffffff8111156200095e576200095d620004f7565b5b6200096a825462000737565b62000977828285620008a0565b5f60209050601f831160018114620009ad575f841562000998578287015190505b620009a485826200091a565b86555062000a13565b601f198416620009bd866200076b565b5f5b82811015620009e657848901518255600182019150602085019450602081019050620009bf565b8683101562000a06578489015162000a02601f891682620008fc565b8355505b6001600288020188555050505b505050505050565b5f819050919050565b5f67ffffffffffffffff82169050919050565b5f62000a5762000a5162000a4b8462000a1b565b620007f6565b62000a24565b9050919050565b62000a698162000a37565b82525050565b5f60208201905062000a845f83018462000a5e565b92915050565b611a048062000a985f395ff3fe608060405234801561000f575f80fd5b506004361061009c575f3560e01c8063715018a611610064578063715018a61461017d5780638bb749af146101875780638da5cb5b146101a5578063f2fde38b146101c3578063f62d1888146101df5761009c565b80631245beaa146100a05780633d9c6957146100bc5780633d9c78e0146100ed57806348943e231461011d57806354d38e6b1461014d575b5f80fd5b6100ba60048036038101906100b591906110ac565b6101fb565b005b6100d660048036038101906100d191906110ac565b61034c565b6040516100e49291906111e4565b60405180910390f35b61010760048036038101906101029190611212565b61079b565b6040516101149190611271565b60405180910390f35b610137600480360381019061013291906112b4565b6107c8565b604051610144919061130e565b60405180910390f35b610167600480360381019061016291906112b4565b610891565b604051610174919061130e565b60405180910390f35b61018561095a565b005b61018f61096d565b60405161019c919061130e565b60405180910390f35b6101ad6109f9565b6040516101ba919061136d565b60405180910390f35b6101dd60048036038101906101d891906113b0565b610a20565b005b6101f960048036038101906101f49190611212565b610aa4565b005b610203610c35565b5f825111610246576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161023d90611425565b60405180910390fd5b5f815111610289576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102809061148d565b60405180910390fd5b8160028460405161029a91906114e5565b908152602001604051809103902090805190602001906102bb929190610dab565b50806003846040516102cd91906114e5565b908152602001604051809103902090805190602001906102ee929190610dab565b504260048460405161030091906114e5565b9081526020016040518091039020819055507f7cdb51e9dbbc205231228146c3246e7f914aa6d4a33170e43ecc8e3593481d1a60405161033f90611545565b60405180910390a1505050565b5f60605f60028660405161036091906114e5565b9081526020016040518091039020805480602002602001604051908101604052809291908181526020015f905b82821015610435578382905f5260205f200180546103aa90611590565b80601f01602080910402602001604051908101604052809291908181526020018280546103d690611590565b80156104215780601f106103f857610100808354040283529160200191610421565b820191905f5260205f20905b81548152906001019060200180831161040457829003601f168201915b50505050508152602001906001019061038d565b5050505090505f60038760405161044c91906114e5565b9081526020016040518091039020805480602002602001604051908101604052809291908181526020015f905b82821015610521578382905f5260205f2001805461049690611590565b80601f01602080910402602001604051908101604052809291908181526020018280546104c290611590565b801561050d5780601f106104e45761010080835404028352916020019161050d565b820191905f5260205f20905b8154815290600101906020018083116104f057829003601f168201915b505050505081526020019060010190610479565b5050505090505f60048860405161053891906114e5565b90815260200160405180910390205490505f8103610576575f60405180606001604052806032815260200161199d6032913994509450505050610793565b5f5b8751811015610672575f805b8551811015610630578581815181106105a05761059f6115c0565b5b60200260200101516040516020016105b891906114e5565b604051602081830303815290604052805190602001208a84815181106105e1576105e06115c0565b5b60200260200101516040516020016105f991906114e5565b604051602081830303815290604052805190602001200361061d5760019150610630565b80806106289061161a565b915050610584565b508061065e575f60405180606001604052806022815260200161197b60229139965096505050505050610793565b50808061066a9061161a565b915050610578565b505f5b865181101561076f575f805b845181101561072d5784818151811061069d5761069c6115c0565b5b60200260200101516040516020016106b591906114e5565b604051602081830303815290604052805190602001208984815181106106de576106dd6115c0565b5b60200260200101516040516020016106f691906114e5565b604051602081830303815290604052805190602001200361071a576001915061072d565b80806107259061161a565b915050610681565b508061075b575f60405180606001604052806022815260200161193360229139965096505050505050610793565b5080806107679061161a565b915050610675565b50600160405180606001604052806026815260200161195560269139945094505050505b935093915050565b6004818051602081018201805184825260208301602085012081835280955050505050505f915090505481565b60028280516020810182018051848252602083016020850120818352809550505050505081815481106107f9575f80fd5b905f5260205f20015f9150915050805461081290611590565b80601f016020809104026020016040519081016040528092919081815260200182805461083e90611590565b80156108895780601f1061086057610100808354040283529160200191610889565b820191905f5260205f20905b81548152906001019060200180831161086c57829003601f168201915b505050505081565b60038280516020810182018051848252602083016020850120818352809550505050505081815481106108c2575f80fd5b905f5260205f20015f915091505080546108db90611590565b80601f016020809104026020016040519081016040528092919081815260200182805461090790611590565b80156109525780601f1061092957610100808354040283529160200191610952565b820191905f5260205f20905b81548152906001019060200180831161093557829003601f168201915b505050505081565b610962610c35565b61096b5f610cbc565b565b6001805461097a90611590565b80601f01602080910402602001604051908101604052809291908181526020018280546109a690611590565b80156109f15780601f106109c8576101008083540402835291602001916109f1565b820191905f5260205f20905b8154815290600101906020018083116109d457829003601f168201915b505050505081565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b610a28610c35565b5f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603610a98575f6040517f1e4fbdf7000000000000000000000000000000000000000000000000000000008152600401610a8f919061136d565b60405180910390fd5b610aa181610cbc565b50565b5f610aad610d7d565b90505f815f0160089054906101000a900460ff161590505f825f015f9054906101000a900467ffffffffffffffff1690505f808267ffffffffffffffff16148015610af55750825b90505f60018367ffffffffffffffff16148015610b2857505f3073ffffffffffffffffffffffffffffffffffffffff163b145b905081158015610b36575080155b15610b6d576040517ff92ee8a900000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6001855f015f6101000a81548167ffffffffffffffff021916908367ffffffffffffffff1602179055508315610bba576001855f0160086101000a81548160ff0219169083151502179055505b8560019081610bc991906117fe565b50610bd333610a20565b8315610c2d575f855f0160086101000a81548160ff0219169083151502179055507fc7f505b2f371ae2175ee4913f4499e1f2633a7b5936321eed1cdaeb6115181d26001604051610c249190611919565b60405180910390a15b505050505050565b610c3d610da4565b73ffffffffffffffffffffffffffffffffffffffff16610c5b6109f9565b73ffffffffffffffffffffffffffffffffffffffff1614610cba57610c7e610da4565b6040517f118cdaa7000000000000000000000000000000000000000000000000000000008152600401610cb1919061136d565b60405180910390fd5b565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050815f806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b5f7ff0c57e16840df040f15088dc2f81fe391c3923bec73e23a9662efc9c229c6a00905090565b5f33905090565b828054828255905f5260205f20908101928215610df1579160200282015b82811115610df0578251829081610de091906117fe565b5091602001919060010190610dc9565b5b509050610dfe9190610e02565b5090565b5b80821115610e21575f8181610e189190610e25565b50600101610e03565b5090565b508054610e3190611590565b5f825580601f10610e425750610e5f565b601f0160209004905f5260205f2090810190610e5e9190610e62565b5b50565b5b80821115610e79575f815f905550600101610e63565b5090565b5f604051905090565b5f80fd5b5f80fd5b5f80fd5b5f80fd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b610edc82610e96565b810181811067ffffffffffffffff82111715610efb57610efa610ea6565b5b80604052505050565b5f610f0d610e7d565b9050610f198282610ed3565b919050565b5f67ffffffffffffffff821115610f3857610f37610ea6565b5b610f4182610e96565b9050602081019050919050565b828183375f83830152505050565b5f610f6e610f6984610f1e565b610f04565b905082815260208101848484011115610f8a57610f89610e92565b5b610f95848285610f4e565b509392505050565b5f82601f830112610fb157610fb0610e8e565b5b8135610fc1848260208601610f5c565b91505092915050565b5f67ffffffffffffffff821115610fe457610fe3610ea6565b5b602082029050602081019050919050565b5f80fd5b5f61100b61100684610fca565b610f04565b9050808382526020820190506020840283018581111561102e5761102d610ff5565b5b835b8181101561107557803567ffffffffffffffff81111561105357611052610e8e565b5b8086016110608982610f9d565b85526020850194505050602081019050611030565b5050509392505050565b5f82601f83011261109357611092610e8e565b5b81356110a3848260208601610ff9565b91505092915050565b5f805f606084860312156110c3576110c2610e86565b5b5f84013567ffffffffffffffff8111156110e0576110df610e8a565b5b6110ec86828701610f9d565b935050602084013567ffffffffffffffff81111561110d5761110c610e8a565b5b6111198682870161107f565b925050604084013567ffffffffffffffff81111561113a57611139610e8a565b5b6111468682870161107f565b9150509250925092565b5f8115159050919050565b61116481611150565b82525050565b5f81519050919050565b5f82825260208201905092915050565b5f5b838110156111a1578082015181840152602081019050611186565b5f8484015250505050565b5f6111b68261116a565b6111c08185611174565b93506111d0818560208601611184565b6111d981610e96565b840191505092915050565b5f6040820190506111f75f83018561115b565b818103602083015261120981846111ac565b90509392505050565b5f6020828403121561122757611226610e86565b5b5f82013567ffffffffffffffff81111561124457611243610e8a565b5b61125084828501610f9d565b91505092915050565b5f819050919050565b61126b81611259565b82525050565b5f6020820190506112845f830184611262565b92915050565b61129381611259565b811461129d575f80fd5b50565b5f813590506112ae8161128a565b92915050565b5f80604083850312156112ca576112c9610e86565b5b5f83013567ffffffffffffffff8111156112e7576112e6610e8a565b5b6112f385828601610f9d565b9250506020611304858286016112a0565b9150509250929050565b5f6020820190508181035f83015261132681846111ac565b905092915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6113578261132e565b9050919050565b6113678161134d565b82525050565b5f6020820190506113805f83018461135e565b92915050565b61138f8161134d565b8114611399575f80fd5b50565b5f813590506113aa81611386565b92915050565b5f602082840312156113c5576113c4610e86565b5b5f6113d28482850161139c565b91505092915050565b7f61757468726f6c657320617272617920697320656d70747900000000000000005f82015250565b5f61140f601883611174565b915061141a826113db565b602082019050919050565b5f6020820190508181035f83015261143c81611403565b9050919050565b7f61757468676f616c7320617272617920697320656d70747900000000000000005f82015250565b5f611477601883611174565b915061148282611443565b602082019050919050565b5f6020820190508181035f8301526114a48161146b565b9050919050565b5f81905092915050565b5f6114bf8261116a565b6114c981856114ab565b93506114d9818560208601611184565b80840191505092915050565b5f6114f082846114b5565b915081905092915050565b7f4461746120736574207375636365737366756c6c7900000000000000000000005f82015250565b5f61152f601583611174565b915061153a826114fb565b602082019050919050565b5f6020820190508181035f83015261155c81611523565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f60028204905060018216806115a757607f821691505b6020821081036115ba576115b9611563565b5b50919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f61162482611259565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203611656576116556115ed565b5b600182019050919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f600883026116bd7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82611682565b6116c78683611682565b95508019841693508086168417925050509392505050565b5f819050919050565b5f6117026116fd6116f884611259565b6116df565b611259565b9050919050565b5f819050919050565b61171b836116e8565b61172f61172782611709565b84845461168e565b825550505050565b5f90565b611743611737565b61174e818484611712565b505050565b5b81811015611771576117665f8261173b565b600181019050611754565b5050565b601f8211156117b65761178781611661565b61179084611673565b8101602085101561179f578190505b6117b36117ab85611673565b830182611753565b50505b505050565b5f82821c905092915050565b5f6117d65f19846008026117bb565b1980831691505092915050565b5f6117ee83836117c7565b9150826002028217905092915050565b6118078261116a565b67ffffffffffffffff8111156118205761181f610ea6565b5b61182a8254611590565b611835828285611775565b5f60209050601f831160018114611866575f8415611854578287015190505b61185e85826117e3565b8655506118c5565b601f19841661187486611661565b5f5b8281101561189b57848901518255600182019150602085019450602081019050611876565b868310156118b857848901516118b4601f8916826117c7565b8355505b6001600288020188555050505b505050505050565b5f819050919050565b5f67ffffffffffffffff82169050919050565b5f6119036118fe6118f9846118cd565b6116df565b6118d6565b9050919050565b611913816118e9565b82525050565b5f60208201905061192c5f83018461190a565b9291505056fe5b50415353204661696c65645d20525020676f616c732061726520696e76616c69645b504153535d2052502069732076616c696420696e2074686520766572696669636174696f6e5b50415353204661696c65645d20525020726f6c65732061726520696e76616c69645b50415353204661696c65645d204e6f206461746120656e74727920666f756e6420666f72207468697320646174615f6964a2646970667358221220cb83012d7b9ad37a5819617055149df00158aab9d2a995d6810f4f8903cdcafd64736f6c63430008140033";

const deploy_ro_smartcontract = async (RO_id_hashing : string) => {

    try{
        const public_wallet = await get_public_wallet();
        let ro_vaultBX_address = await (await roid_address_smart_contract_instance).methods.getVaultBX(RO_id_hashing).call();

        // get sign_tx of deploy smart contract by vaultBX wallet
        const contract = new web3.eth.Contract(ro_smartcontract_abi as any);
        const data = await contract.deploy({ data: ro_smartcontract_bytecode, arguments: [RO_id_hashing] }).encodeABI();
        const nonce = await web3.eth.getTransactionCount(ro_vaultBX_address, 'pending');

        const tx = {
            address_from: ro_vaultBX_address,
            address_to: null,  // 因為是部署合約，所以沒有接收地址
            chainID : "1337", 
            amount : "0",  
            gas_price : await web3.eth.getGasPrice(),  
            gas_limit : 10000000,  
            nonce : nonce,  
            data : data,  
            is_private : false 
        }

        let sign_tx = await send_sign_tx(RO_id_hashing, tx);
        let signed_transaction = sign_tx?.data.data.signed_transaction;
        console.log('[deploy_smart_contract] get signed_transaction to deploy the contract: ', signed_transaction);

        // send the sign_tx and deploy smart contract 
        const receipt = await web3.eth.sendSignedTransaction(signed_transaction as any);
        const contarct_address = receipt.contractAddress;
        console.log(`[deploy_smart_contract] roid_smartcontract deploy for "${RO_id_hashing}" at "${contarct_address}" [OK]`);
    
        // add to roid_address
        await (await roid_address_smart_contract_instance).methods.setSmartContract(RO_id_hashing, contarct_address).send({ from: public_wallet });

        console.log(`[smart contract method] roid_smartcontract use setSamrtContract mapping : ${RO_id_hashing} => ${contarct_address} [OK]`);

        return contarct_address;

    }catch(err){
        console.error(`[deploy smart contract] deploy_ro_smartcontract error : ${err}`);
    }
}

const get_ro_contract_address = async (ro_id_hashing : string) => {
    let ro_contract_address = await (await roid_address_smart_contract_instance).methods.getSmartContract(ro_id_hashing).call();

    if(ro_contract_address == "0x0000000000000000000000000000000000000000"){
        ro_contract_address = await deploy_ro_smartcontract(ro_id_hashing);
    }

    return ro_contract_address;
}

const get_ro_smart_contract_instance = async ( contract_address : string ) => {
    const ro_smartcontract_smart_contract_instance = new web3.eth.Contract(ro_smartcontract_abi as any, contract_address);
    return ro_smartcontract_smart_contract_instance;
}