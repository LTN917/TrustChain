/*
    run the file to create the first roid_address smart contract
    npx ts-node -P tsconfig.server.json ./blockchain/ethereum_env.ts
*/ 

import Web3 from 'web3';
import { send_sign_tx } from '../vautlBX/methods';

export { web3, roid_address_smart_contract_instance, deploy_ro_smartcontract, get_ro_contract_address, get_ro_smart_contract_instance, deploy_roid_address, get_public_wallet };


// creating Web3 instance to localhost Hardhat
const web3 = new Web3('http://localhost:8545');

//ganache first wallet address
const get_public_wallet = async () => {
    const accounts = await web3.eth.getAccounts();
    return accounts[0];
}

// ================================ smart contract - roid_address =============================================
const roid_address_abi = [
    {
        "inputs": [],
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "owner",
                "type": "address"
            }
        ],
        "name": "OwnableInvalidOwner",
        "type": "error"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "account",
                "type": "address"
            }
        ],
        "name": "OwnableUnauthorizedAccount",
        "type": "error"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "previousOwner",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "newOwner",
                "type": "address"
            }
        ],
        "name": "OwnershipTransferred",
        "type": "event"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "roid_hashing",
                "type": "string"
            }
        ],
        "name": "getSmartContract",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "roid_hashing",
                "type": "string"
            }
        ],
        "name": "getVaultBX",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "owner",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "renounceOwnership",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "roid_hash",
                "type": "string"
            },
            {
                "internalType": "address",
                "name": "smartContract_address",
                "type": "address"
            }
        ],
        "name": "setSmartContract",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "roid_hashing",
                "type": "string"
            },
            {
                "internalType": "address",
                "name": "vaultBX_address",
                "type": "address"
            }
        ],
        "name": "setVaultBX",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "newOwner",
                "type": "address"
            }
        ],
        "name": "transferOwnership",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "roid_hashing",
                "type": "string"
            },
            {
                "internalType": "address",
                "name": "vaultBX_address",
                "type": "address"
            }
        ],
        "name": "verifyVaultBX",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    }
];

const roid_address_bytecode ="608060405234801561000f575f80fd5b50335f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603610081575f6040517f1e4fbdf70000000000000000000000000000000000000000000000000000000081526004016100789190610196565b60405180910390fd5b6100908161009660201b60201c565b506101af565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050815f806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61018082610157565b9050919050565b61019081610176565b82525050565b5f6020820190506101a95f830184610187565b92915050565b61090a806101bc5f395ff3fe608060405234801561000f575f80fd5b5060043610610086575f3560e01c80638da5cb5b116100595780638da5cb5b14610110578063c58992201461012e578063c6c4fbc61461015e578063f2fde38b1461017a57610086565b806340763c3e1461008a5780634986b388146100ba578063648451a8146100ea578063715018a614610106575b5f80fd5b6100a4600480360381019061009f91906106d1565b610196565b6040516100b19190610757565b60405180910390f35b6100d460048036038101906100cf919061079a565b6101e4565b6040516100e1919061080e565b60405180910390f35b61010460048036038101906100ff919061079a565b610259565b005b61010e6102c1565b005b6101186102d4565b6040516101259190610757565b60405180910390f35b610148600480360381019061014391906106d1565b6102fb565b6040516101559190610757565b60405180910390f35b6101786004803603810190610173919061079a565b610349565b005b610194600480360381019061018f9190610827565b6103b1565b005b5f61019f610435565b6002826040516101af91906108be565b90815260200160405180910390205f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b5f8173ffffffffffffffffffffffffffffffffffffffff1660018460405161020c91906108be565b90815260200160405180910390205f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614905092915050565b610261610435565b8060018360405161027291906108be565b90815260200160405180910390205f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050565b6102c9610435565b6102d25f6104bc565b565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b5f610304610435565b60018260405161031491906108be565b90815260200160405180910390205f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b610351610435565b8060028360405161036291906108be565b90815260200160405180910390205f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050565b6103b9610435565b5f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603610429575f6040517f1e4fbdf70000000000000000000000000000000000000000000000000000000081526004016104209190610757565b60405180910390fd5b610432816104bc565b50565b61043d61057d565b73ffffffffffffffffffffffffffffffffffffffff1661045b6102d4565b73ffffffffffffffffffffffffffffffffffffffff16146104ba5761047e61057d565b6040517f118cdaa70000000000000000000000000000000000000000000000000000000081526004016104b19190610757565b60405180910390fd5b565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050815f806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b5f33905090565b5f604051905090565b5f80fd5b5f80fd5b5f80fd5b5f80fd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b6105e38261059d565b810181811067ffffffffffffffff82111715610602576106016105ad565b5b80604052505050565b5f610614610584565b905061062082826105da565b919050565b5f67ffffffffffffffff82111561063f5761063e6105ad565b5b6106488261059d565b9050602081019050919050565b828183375f83830152505050565b5f61067561067084610625565b61060b565b90508281526020810184848401111561069157610690610599565b5b61069c848285610655565b509392505050565b5f82601f8301126106b8576106b7610595565b5b81356106c8848260208601610663565b91505092915050565b5f602082840312156106e6576106e561058d565b5b5f82013567ffffffffffffffff81111561070357610702610591565b5b61070f848285016106a4565b91505092915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61074182610718565b9050919050565b61075181610737565b82525050565b5f60208201905061076a5f830184610748565b92915050565b61077981610737565b8114610783575f80fd5b50565b5f8135905061079481610770565b92915050565b5f80604083850312156107b0576107af61058d565b5b5f83013567ffffffffffffffff8111156107cd576107cc610591565b5b6107d9858286016106a4565b92505060206107ea85828601610786565b9150509250929050565b5f8115159050919050565b610808816107f4565b82525050565b5f6020820190506108215f8301846107ff565b92915050565b5f6020828403121561083c5761083b61058d565b5b5f61084984828501610786565b91505092915050565b5f81519050919050565b5f81905092915050565b5f5b83811015610883578082015181840152602081019050610868565b5f8484015250505050565b5f61089882610852565b6108a2818561085c565b93506108b2818560208601610866565b80840191505092915050565b5f6108c9828461088e565b91508190509291505056fea2646970667358221220aedddb1175f815b90819e83fe15fb13493ef6ee066e13165c5089c0cb312ae6764736f6c63430008140033";

let roid_address_smart_contract_instance : any;

const deploy_roid_address = async (platform_name : string) => {

    try{
        const public_wallet = await get_public_wallet();

        const contract = new web3.eth.Contract(roid_address_abi as any);
        const contract_instance = await contract.deploy({
            data: roid_address_bytecode,
            arguments: []
        })
        .send({
            from: public_wallet,
            gas: 5000000,      // 增加 gas 限制
            gasPrice: '900000000'    
        });

        roid_address_smart_contract_instance = new web3.eth.Contract(roid_address_abi as any, contract_instance.options.address);

        console.log(`[deploy smart contract] roid_address deploy for '${platform_name}' at : ${contract_instance.options.address} [OK]`);

        return contract_instance.options.address;
    }catch(err){
        console.log(`[deploy smart contract] roid_address error : ${err}`);
    }
}

// ================================ smart contract - ro_smartcontract  =================================================
const ro_smartcontract_abi = [
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "_RO_id_hashing",
                "type": "string"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "inputs": [],
        "name": "InvalidInitialization",
        "type": "error"
    },
    {
        "inputs": [],
        "name": "NotInitializing",
        "type": "error"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "owner",
                "type": "address"
            }
        ],
        "name": "OwnableInvalidOwner",
        "type": "error"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "account",
                "type": "address"
            }
        ],
        "name": "OwnableUnauthorizedAccount",
        "type": "error"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "string",
                "name": "message",
                "type": "string"
            }
        ],
        "name": "Debug",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "uint64",
                "name": "version",
                "type": "uint64"
            }
        ],
        "name": "Initialized",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "previousOwner",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "newOwner",
                "type": "address"
            }
        ],
        "name": "OwnershipTransferred",
        "type": "event"
    },
    {
        "inputs": [],
        "name": "RO_id_hashing",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            },
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "dataid_authgoals",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            },
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "dataid_authroles",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "name": "dataid_timestamp",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "_RO_id_hashing",
                "type": "string"
            }
        ],
        "name": "initialize",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "owner",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "renounceOwnership",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "data_id",
                "type": "string"
            },
            {
                "internalType": "string[]",
                "name": "authroles",
                "type": "string[]"
            },
            {
                "internalType": "string[]",
                "name": "authgoals",
                "type": "string[]"
            }
        ],
        "name": "set_data_auth",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "newOwner",
                "type": "address"
            }
        ],
        "name": "transferOwnership",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "data_id",
                "type": "string"
            },
            {
                "internalType": "string[]",
                "name": "rp_auth_roles",
                "type": "string[]"
            },
            {
                "internalType": "string[]",
                "name": "rp_auth_goals",
                "type": "string[]"
            }
        ],
        "name": "verify_rp",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            },
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    }
];

const ro_smartcontract_bytecode = "608060405234801562000010575f80fd5b50604051620024a4380380620024a4833981810160405281019062000036919062000653565b335f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603620000aa575f6040517f1e4fbdf7000000000000000000000000000000000000000000000000000000008152600401620000a19190620006e5565b60405180910390fd5b620000bb81620000d460201b60201c565b50620000cd816200019560201b60201c565b5062000a8a565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050815f806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b5f620001a66200034060201b60201c565b90505f815f0160089054906101000a900460ff161590505f825f015f9054906101000a900467ffffffffffffffff1690505f808267ffffffffffffffff16148015620001ef5750825b90505f60018367ffffffffffffffff161480156200022357505f3073ffffffffffffffffffffffffffffffffffffffff163b145b90508115801562000232575080155b156200026a576040517ff92ee8a900000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6001855f015f6101000a81548167ffffffffffffffff021916908367ffffffffffffffff1602179055508315620002b8576001855f0160086101000a81548160ff0219169083151502179055505b8560019081620002c9919062000937565b50620002db336200036760201b60201c565b831562000338575f855f0160086101000a81548160ff0219169083151502179055507fc7f505b2f371ae2175ee4913f4499e1f2633a7b5936321eed1cdaeb6115181d260016040516200032f919062000a6f565b60405180910390a15b505050505050565b5f7ff0c57e16840df040f15088dc2f81fe391c3923bec73e23a9662efc9c229c6a00905090565b62000377620003fe60201b60201c565b5f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603620003ea575f6040517f1e4fbdf7000000000000000000000000000000000000000000000000000000008152600401620003e19190620006e5565b60405180910390fd5b620003fb81620000d460201b60201c565b50565b6200040e620004a060201b60201c565b73ffffffffffffffffffffffffffffffffffffffff1662000434620004a760201b60201c565b73ffffffffffffffffffffffffffffffffffffffff16146200049e5762000460620004a060201b60201c565b6040517f118cdaa7000000000000000000000000000000000000000000000000000000008152600401620004959190620006e5565b60405180910390fd5b565b5f33905090565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b5f604051905090565b5f80fd5b5f80fd5b5f80fd5b5f80fd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b6200052f82620004e7565b810181811067ffffffffffffffff82111715620005515762000550620004f7565b5b80604052505050565b5f62000565620004ce565b905062000573828262000524565b919050565b5f67ffffffffffffffff821115620005955762000594620004f7565b5b620005a082620004e7565b9050602081019050919050565b5f5b83811015620005cc578082015181840152602081019050620005af565b5f8484015250505050565b5f620005ed620005e78462000578565b6200055a565b9050828152602081018484840111156200060c576200060b620004e3565b5b62000619848285620005ad565b509392505050565b5f82601f830112620006385762000637620004df565b5b81516200064a848260208601620005d7565b91505092915050565b5f602082840312156200066b576200066a620004d7565b5b5f82015167ffffffffffffffff8111156200068b576200068a620004db565b5b620006998482850162000621565b91505092915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f620006cd82620006a2565b9050919050565b620006df81620006c1565b82525050565b5f602082019050620006fa5f830184620006d4565b92915050565b5f81519050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f60028204905060018216806200074f57607f821691505b6020821081036200076557620007646200070a565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f60088302620007c97fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826200078c565b620007d586836200078c565b95508019841693508086168417925050509392505050565b5f819050919050565b5f819050919050565b5f6200081f620008196200081384620007ed565b620007f6565b620007ed565b9050919050565b5f819050919050565b6200083a83620007ff565b62000852620008498262000826565b84845462000798565b825550505050565b5f90565b620008686200085a565b620008758184846200082f565b505050565b5b818110156200089c57620008905f826200085e565b6001810190506200087b565b5050565b601f821115620008eb57620008b5816200076b565b620008c0846200077d565b81016020851015620008d0578190505b620008e8620008df856200077d565b8301826200087a565b50505b505050565b5f82821c905092915050565b5f6200090d5f1984600802620008f0565b1980831691505092915050565b5f620009278383620008fc565b9150826002028217905092915050565b620009428262000700565b67ffffffffffffffff8111156200095e576200095d620004f7565b5b6200096a825462000737565b62000977828285620008a0565b5f60209050601f831160018114620009ad575f841562000998578287015190505b620009a485826200091a565b86555062000a13565b601f198416620009bd866200076b565b5f5b82811015620009e657848901518255600182019150602085019450602081019050620009bf565b8683101562000a06578489015162000a02601f891682620008fc565b8355505b6001600288020188555050505b505050505050565b5f819050919050565b5f67ffffffffffffffff82169050919050565b5f62000a5762000a5162000a4b8462000a1b565b620007f6565b62000a24565b9050919050565b62000a698162000a37565b82525050565b5f60208201905062000a845f83018462000a5e565b92915050565b611a0c8062000a985f395ff3fe608060405234801561000f575f80fd5b506004361061009c575f3560e01c8063715018a611610064578063715018a61461017d5780638bb749af146101875780638da5cb5b146101a5578063f2fde38b146101c3578063f62d1888146101df5761009c565b80631245beaa146100a05780633d9c6957146100bc5780633d9c78e0146100ed57806348943e231461011d57806354d38e6b1461014d575b5f80fd5b6100ba60048036038101906100b591906110b4565b6101fb565b005b6100d660048036038101906100d191906110b4565b61034c565b6040516100e49291906111ec565b60405180910390f35b6101076004803603810190610102919061121a565b6107a3565b6040516101149190611279565b60405180910390f35b610137600480360381019061013291906112bc565b6107d0565b6040516101449190611316565b60405180910390f35b610167600480360381019061016291906112bc565b610899565b6040516101749190611316565b60405180910390f35b610185610962565b005b61018f610975565b60405161019c9190611316565b60405180910390f35b6101ad610a01565b6040516101ba9190611375565b60405180910390f35b6101dd60048036038101906101d891906113b8565b610a28565b005b6101f960048036038101906101f4919061121a565b610aac565b005b610203610c3d565b5f825111610246576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161023d9061142d565b60405180910390fd5b5f815111610289576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161028090611495565b60405180910390fd5b8160028460405161029a91906114ed565b908152602001604051809103902090805190602001906102bb929190610db3565b50806003846040516102cd91906114ed565b908152602001604051809103902090805190602001906102ee929190610db3565b504260048460405161030091906114ed565b9081526020016040518091039020819055507f7cdb51e9dbbc205231228146c3246e7f914aa6d4a33170e43ecc8e3593481d1a60405161033f9061154d565b60405180910390a1505050565b5f6060610357610c3d565b5f60028660405161036891906114ed565b9081526020016040518091039020805480602002602001604051908101604052809291908181526020015f905b8282101561043d578382905f5260205f200180546103b290611598565b80601f01602080910402602001604051908101604052809291908181526020018280546103de90611598565b80156104295780601f1061040057610100808354040283529160200191610429565b820191905f5260205f20905b81548152906001019060200180831161040c57829003601f168201915b505050505081526020019060010190610395565b5050505090505f60038760405161045491906114ed565b9081526020016040518091039020805480602002602001604051908101604052809291908181526020015f905b82821015610529578382905f5260205f2001805461049e90611598565b80601f01602080910402602001604051908101604052809291908181526020018280546104ca90611598565b80156105155780601f106104ec57610100808354040283529160200191610515565b820191905f5260205f20905b8154815290600101906020018083116104f857829003601f168201915b505050505081526020019060010190610481565b5050505090505f60048860405161054091906114ed565b90815260200160405180910390205490505f810361057e575f6040518060600160405280603281526020016119a5603291399450945050505061079b565b5f5b875181101561067a575f805b8551811015610638578581815181106105a8576105a76115c8565b5b60200260200101516040516020016105c091906114ed565b604051602081830303815290604052805190602001208a84815181106105e9576105e86115c8565b5b602002602001015160405160200161060191906114ed565b60405160208183030381529060405280519060200120036106255760019150610638565b808061063090611622565b91505061058c565b5080610666575f6040518060600160405280602281526020016119836022913996509650505050505061079b565b50808061067290611622565b915050610580565b505f5b8651811015610777575f805b8451811015610735578481815181106106a5576106a46115c8565b5b60200260200101516040516020016106bd91906114ed565b604051602081830303815290604052805190602001208984815181106106e6576106e56115c8565b5b60200260200101516040516020016106fe91906114ed565b60405160208183030381529060405280519060200120036107225760019150610735565b808061072d90611622565b915050610689565b5080610763575f60405180606001604052806022815260200161193b6022913996509650505050505061079b565b50808061076f90611622565b91505061067d565b50600160405180606001604052806026815260200161195d60269139945094505050505b935093915050565b6004818051602081018201805184825260208301602085012081835280955050505050505f915090505481565b6002828051602081018201805184825260208301602085012081835280955050505050508181548110610801575f80fd5b905f5260205f20015f9150915050805461081a90611598565b80601f016020809104026020016040519081016040528092919081815260200182805461084690611598565b80156108915780601f1061086857610100808354040283529160200191610891565b820191905f5260205f20905b81548152906001019060200180831161087457829003601f168201915b505050505081565b60038280516020810182018051848252602083016020850120818352809550505050505081815481106108ca575f80fd5b905f5260205f20015f915091505080546108e390611598565b80601f016020809104026020016040519081016040528092919081815260200182805461090f90611598565b801561095a5780601f106109315761010080835404028352916020019161095a565b820191905f5260205f20905b81548152906001019060200180831161093d57829003601f168201915b505050505081565b61096a610c3d565b6109735f610cc4565b565b6001805461098290611598565b80601f01602080910402602001604051908101604052809291908181526020018280546109ae90611598565b80156109f95780601f106109d0576101008083540402835291602001916109f9565b820191905f5260205f20905b8154815290600101906020018083116109dc57829003601f168201915b505050505081565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b610a30610c3d565b5f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603610aa0575f6040517f1e4fbdf7000000000000000000000000000000000000000000000000000000008152600401610a979190611375565b60405180910390fd5b610aa981610cc4565b50565b5f610ab5610d85565b90505f815f0160089054906101000a900460ff161590505f825f015f9054906101000a900467ffffffffffffffff1690505f808267ffffffffffffffff16148015610afd5750825b90505f60018367ffffffffffffffff16148015610b3057505f3073ffffffffffffffffffffffffffffffffffffffff163b145b905081158015610b3e575080155b15610b75576040517ff92ee8a900000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6001855f015f6101000a81548167ffffffffffffffff021916908367ffffffffffffffff1602179055508315610bc2576001855f0160086101000a81548160ff0219169083151502179055505b8560019081610bd19190611806565b50610bdb33610a28565b8315610c35575f855f0160086101000a81548160ff0219169083151502179055507fc7f505b2f371ae2175ee4913f4499e1f2633a7b5936321eed1cdaeb6115181d26001604051610c2c9190611921565b60405180910390a15b505050505050565b610c45610dac565b73ffffffffffffffffffffffffffffffffffffffff16610c63610a01565b73ffffffffffffffffffffffffffffffffffffffff1614610cc257610c86610dac565b6040517f118cdaa7000000000000000000000000000000000000000000000000000000008152600401610cb99190611375565b60405180910390fd5b565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050815f806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b5f7ff0c57e16840df040f15088dc2f81fe391c3923bec73e23a9662efc9c229c6a00905090565b5f33905090565b828054828255905f5260205f20908101928215610df9579160200282015b82811115610df8578251829081610de89190611806565b5091602001919060010190610dd1565b5b509050610e069190610e0a565b5090565b5b80821115610e29575f8181610e209190610e2d565b50600101610e0b565b5090565b508054610e3990611598565b5f825580601f10610e4a5750610e67565b601f0160209004905f5260205f2090810190610e669190610e6a565b5b50565b5b80821115610e81575f815f905550600101610e6b565b5090565b5f604051905090565b5f80fd5b5f80fd5b5f80fd5b5f80fd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b610ee482610e9e565b810181811067ffffffffffffffff82111715610f0357610f02610eae565b5b80604052505050565b5f610f15610e85565b9050610f218282610edb565b919050565b5f67ffffffffffffffff821115610f4057610f3f610eae565b5b610f4982610e9e565b9050602081019050919050565b828183375f83830152505050565b5f610f76610f7184610f26565b610f0c565b905082815260208101848484011115610f9257610f91610e9a565b5b610f9d848285610f56565b509392505050565b5f82601f830112610fb957610fb8610e96565b5b8135610fc9848260208601610f64565b91505092915050565b5f67ffffffffffffffff821115610fec57610feb610eae565b5b602082029050602081019050919050565b5f80fd5b5f61101361100e84610fd2565b610f0c565b9050808382526020820190506020840283018581111561103657611035610ffd565b5b835b8181101561107d57803567ffffffffffffffff81111561105b5761105a610e96565b5b8086016110688982610fa5565b85526020850194505050602081019050611038565b5050509392505050565b5f82601f83011261109b5761109a610e96565b5b81356110ab848260208601611001565b91505092915050565b5f805f606084860312156110cb576110ca610e8e565b5b5f84013567ffffffffffffffff8111156110e8576110e7610e92565b5b6110f486828701610fa5565b935050602084013567ffffffffffffffff81111561111557611114610e92565b5b61112186828701611087565b925050604084013567ffffffffffffffff81111561114257611141610e92565b5b61114e86828701611087565b9150509250925092565b5f8115159050919050565b61116c81611158565b82525050565b5f81519050919050565b5f82825260208201905092915050565b5f5b838110156111a957808201518184015260208101905061118e565b5f8484015250505050565b5f6111be82611172565b6111c8818561117c565b93506111d881856020860161118c565b6111e181610e9e565b840191505092915050565b5f6040820190506111ff5f830185611163565b818103602083015261121181846111b4565b90509392505050565b5f6020828403121561122f5761122e610e8e565b5b5f82013567ffffffffffffffff81111561124c5761124b610e92565b5b61125884828501610fa5565b91505092915050565b5f819050919050565b61127381611261565b82525050565b5f60208201905061128c5f83018461126a565b92915050565b61129b81611261565b81146112a5575f80fd5b50565b5f813590506112b681611292565b92915050565b5f80604083850312156112d2576112d1610e8e565b5b5f83013567ffffffffffffffff8111156112ef576112ee610e92565b5b6112fb85828601610fa5565b925050602061130c858286016112a8565b9150509250929050565b5f6020820190508181035f83015261132e81846111b4565b905092915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61135f82611336565b9050919050565b61136f81611355565b82525050565b5f6020820190506113885f830184611366565b92915050565b61139781611355565b81146113a1575f80fd5b50565b5f813590506113b28161138e565b92915050565b5f602082840312156113cd576113cc610e8e565b5b5f6113da848285016113a4565b91505092915050565b7f61757468726f6c657320617272617920697320656d70747900000000000000005f82015250565b5f61141760188361117c565b9150611422826113e3565b602082019050919050565b5f6020820190508181035f8301526114448161140b565b9050919050565b7f61757468676f616c7320617272617920697320656d70747900000000000000005f82015250565b5f61147f60188361117c565b915061148a8261144b565b602082019050919050565b5f6020820190508181035f8301526114ac81611473565b9050919050565b5f81905092915050565b5f6114c782611172565b6114d181856114b3565b93506114e181856020860161118c565b80840191505092915050565b5f6114f882846114bd565b915081905092915050565b7f4461746120736574207375636365737366756c6c7900000000000000000000005f82015250565b5f61153760158361117c565b915061154282611503565b602082019050919050565b5f6020820190508181035f8301526115648161152b565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f60028204905060018216806115af57607f821691505b6020821081036115c2576115c161156b565b5b50919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f61162c82611261565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820361165e5761165d6115f5565b5b600182019050919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f600883026116c57fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8261168a565b6116cf868361168a565b95508019841693508086168417925050509392505050565b5f819050919050565b5f61170a61170561170084611261565b6116e7565b611261565b9050919050565b5f819050919050565b611723836116f0565b61173761172f82611711565b848454611696565b825550505050565b5f90565b61174b61173f565b61175681848461171a565b505050565b5b818110156117795761176e5f82611743565b60018101905061175c565b5050565b601f8211156117be5761178f81611669565b6117988461167b565b810160208510156117a7578190505b6117bb6117b38561167b565b83018261175b565b50505b505050565b5f82821c905092915050565b5f6117de5f19846008026117c3565b1980831691505092915050565b5f6117f683836117cf565b9150826002028217905092915050565b61180f82611172565b67ffffffffffffffff81111561182857611827610eae565b5b6118328254611598565b61183d82828561177d565b5f60209050601f83116001811461186e575f841561185c578287015190505b61186685826117eb565b8655506118cd565b601f19841661187c86611669565b5f5b828110156118a35784890151825560018201915060208501945060208101905061187e565b868310156118c057848901516118bc601f8916826117cf565b8355505b6001600288020188555050505b505050505050565b5f819050919050565b5f67ffffffffffffffff82169050919050565b5f61190b611906611901846118d5565b6116e7565b6118de565b9050919050565b61191b816118f1565b82525050565b5f6020820190506119345f830184611912565b9291505056fe5b50415353204661696c65645d20525020676f616c732061726520696e76616c69645b504153535d2052502069732076616c696420696e2074686520766572696669636174696f6e5b50415353204661696c65645d20525020726f6c65732061726520696e76616c69645b50415353204661696c65645d204e6f206461746120656e74727920666f756e6420666f72207468697320646174615f6964a2646970667358221220853914e6299cd19b5e0de2b07fecbd107d9ed90f57ed0fff86eb6753c689a07164736f6c63430008140033";

const deploy_ro_smartcontract = async (RO_id_hashing : string) => {

    try{
        const public_wallet = await get_public_wallet();
        let ro_vaultBX_address = await (await roid_address_smart_contract_instance).methods.getVaultBX(RO_id_hashing).call();

        // get sign_tx of deploy smart contract by vaultBX wallet
        const contract = new web3.eth.Contract(ro_smartcontract_abi as any);
        const data = await contract.deploy({ data: ro_smartcontract_bytecode, arguments: [RO_id_hashing] }).encodeABI();
        const tx = {
            address_from: ro_vaultBX_address,
            address_to: null,  // 因為是部署合約，所以沒有接收地址
            chainID : "1337", 
            amount : "0",  
            gas_price : await web3.eth.getGasPrice(),  
            gas_limit : 10000000,  
            nonce : await web3.eth.getTransactionCount(ro_vaultBX_address, 'latest'),  
            data : data,  
            is_private : false 
        }

        let sign_tx = await send_sign_tx(RO_id_hashing, tx);
        let signed_transaction = sign_tx?.data.data.signed_transaction;
        console.log('[deploy_smart_contract] get signed_transaction to deploy the contract: ', signed_transaction);

        // send the sign_tx and deploy smart contract 
        const receipt = await web3.eth.sendSignedTransaction(signed_transaction as any);
        const contarct_address = receipt.contractAddress;
        console.log(`[deploy_smart_contract] roid_smartcontract deploy for "${RO_id_hashing}" at "${contarct_address}" [OK]`);
    
        // add to roid_address
        await (await roid_address_smart_contract_instance).methods.setSmartContract(RO_id_hashing, contarct_address).send({ from: public_wallet });

        console.log(`[smart contract method] roid_smartcontract use setSamrtContract mapping : ${RO_id_hashing} => ${contarct_address} [OK]`);

        return contarct_address;

    }catch(err){
        console.error(`[deploy smart contract] deploy_ro_smartcontract error : ${err}`);
    }
}

const get_ro_contract_address = async (ro_id_hashing : string) => {
    let ro_contract_address = await (await roid_address_smart_contract_instance).methods.getSmartContract(ro_id_hashing).call();

    if(ro_contract_address == "0x0000000000000000000000000000000000000000"){
        ro_contract_address = await deploy_ro_smartcontract(ro_id_hashing);
    }

    return ro_contract_address;
}

const get_ro_smart_contract_instance = async ( contract_address : string ) => {
    const ro_smartcontract_smart_contract_instance = new web3.eth.Contract(ro_smartcontract_abi as any, contract_address);
    return ro_smartcontract_smart_contract_instance;
}